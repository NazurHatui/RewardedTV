<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>RewardedTV ‚Äì Battle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <style>
    /* ‚Äî‚Äî Global & Reset ‚Äî‚Äî */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',sans-serif; background:#0a0a0a; color:#e0e0e0; }

    /* ‚Äî‚Äî Header ‚Äî‚Äî */
    header.header {
      display:flex; justify-content:space-between; align-items:center;
      padding:1rem 2rem; background:#111; position:sticky; top:0; width:100%; z-index:10;
    }
    .nav-links { list-style:none; display:flex; gap:1rem; }
    .nav-links a { color:#e0e0e0; text-decoration:none; font-weight:500; }
    .nav-links a.active { color:#f39c12; }

    /* ‚Äî‚Äî Main container ‚Äî‚Äî */
    main { padding:2rem; max-width:1000px; margin:0 auto; }

    /* ‚Äî‚Äî Battle Zone Banner ‚Äî‚Äî */
    #battleBanner {
      background:rgba(243,156,18,0.1); border:2px solid #f39c12;
      border-radius:8px; padding:1rem; text-align:center; margin-bottom:1rem;
    }
    #battleBanner h1 { font-size:2.5rem; color:#f39c12; margin-bottom:0.5rem; }
    #battleBanner p { color:#ccc; font-size:1rem; }

    /* ‚Äî‚Äî Live Bets Feed ‚Äî‚Äî */
    #fakeBets {
      width:100%; background:#111;
      border:2px solid rgba(243,156,18,0.2);
      border-radius:8px; padding:1rem;
      margin-bottom:1.5rem; max-height:150px; overflow-y:auto;
    }
    #fakeBets h3 { color:#f39c12; margin-bottom:0.5rem; font-size:1.1rem; }
    #fakeBets p  { font-size:0.9rem; margin:0.25rem 0; color:#ccc; }

    /* ‚Äî‚Äî Status Bar ‚Äî‚Äî */
    #statusBar {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:1rem;
    }
    #balance { font-size:1.25rem; }
    .btn-pass {
      display:flex; align-items:center; padding:0.75rem 1.5rem;
      background:linear-gradient(45deg,#9b59b6,#e74c3c);
      color:#111; border:none; border-radius:6px; cursor:pointer;
      text-transform:uppercase; font-weight:600;
      box-shadow:0 4px 12px rgba(231,76,60,0.5);
      transition:opacity .3s;
    }
    .btn-pass img { height:1em; margin-right:0.5em; }
    .btn-pass:disabled { opacity:0.5; cursor:default; }

    /* ‚Äî‚Äî Fight Controls ‚Äî‚Äî */
    #fightControls {
      display:flex; gap:1rem; justify-content:center;
      align-items:center; margin:2rem 0;
    }
    #fightControls input[type="number"] {
      width:100px; padding:0.5rem; border-radius:4px; border:none;
      text-align:center; background:linear-gradient(45deg,#e74c3c,#9b59b6);
      color:#111;
    }
    #fightControls label {
      display:flex; align-items:center; gap:0.5rem; color:#e0e0e0;
    }
    #fightControls label input { margin-right:0.25rem; }
    #fightControls button {
      padding:0.75rem 1.5rem; font-size:1rem; border:none; border-radius:6px;
      cursor:pointer; font-weight:600; text-transform:uppercase;
      box-shadow:0 4px 12px rgba(231,76,60,0.5);
      transition:opacity .3s;
      background:linear-gradient(45deg,#e74c3c,#9b59b6);
      color:#111;
    }
    #fightControls button:disabled { opacity:0.5; cursor:default; }
    #fightControls #tournyBtn {
      background:#f39c12; box-shadow:0 4px 12px rgba(243,156,18,0.5);
      color:#111;
    }

    /* ‚Äî‚Äî Character Grid ‚Äî‚Äî */
    #charGrid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:1.5rem; margin-bottom:2rem;
    }
    .char-card {
      background:#1c1c1c; border-radius:8px; padding:1rem;
      text-align:center; box-shadow:0 4px 16px rgba(0,0,0,0.6);
      transition:transform .3s,box-shadow .3s; cursor:pointer; position:relative;
    }
    .char-card.selected {
      box-shadow:0 0 0 4px #f39c12; transform:scale(1.05);
    }
    .char-card img { width:100%; border-radius:4px; margin-bottom:0.5rem; }
    .char-card .label { color:#ccc; margin-bottom:0.5rem; }

    /* ‚Äî‚Äî Battle Items Grid ‚Äî‚Äî */
    #itemGrid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1.5rem; margin-bottom:2rem;
    }
    .item-card {
      position:relative;
      background:#1c1c1c; border-radius:8px; overflow:hidden;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
      display:flex; flex-direction:column;
      transition:transform .3s,box-shadow .3s;
    }
    .item-card:hover {
      transform:translateY(-6px); box-shadow:0 12px 30px rgba(0,0,0,0.8);
    }
    .item-card img {
      width:100%; height:120px; object-fit:contain; background:#000; padding:1rem;
    }
    .item-card .owned {
      position:absolute; top:8px; right:8px;
      background:rgba(0,0,0,0.6); color:#f39c12; padding:2px 6px;
      border-radius:4px; font-size:0.75rem;
    }
    .item-card .body {
      padding:1rem; flex:1; display:flex; flex-direction:column; align-items:center;
    }
    .item-card .body h3 { color:#f39c12; margin-bottom:0.5rem; }
    .item-card .body .stat,
    .item-card .body .price { color:#ccc; margin-bottom:0.5rem; }
    .item-card .body .quantity {
      width:60px; text-align:center; margin-bottom:1rem; padding:0.25rem;
      border:none; border-radius:4px;
    }
    .item-card .body button {
      margin-top:auto; width:100%; padding:0.6rem;
      background:linear-gradient(45deg,#9b59b6,#e74c3c);
      color:#111; border:none; border-radius:6px;
      font-weight:600; text-transform:uppercase; cursor:pointer;
      box-shadow:0 0 10px rgba(231,76,60,0.7); transition:background .3s;
    }
    .item-card .body button:hover {
      background:linear-gradient(45deg,#e74c3c,#9b59b6);
    }

    /* ‚Äî‚Äî VS Loader, Battle Log & Panels ‚Äî‚Äî */
    #loader, #battleLog, #resultPanel { text-align:center; margin-top:3rem; }
    #battleLog { white-space:pre-wrap; max-height:200px; overflow-y:auto; color:#ccc; }
    .vs-panel {
      display:flex; justify-content:space-around; align-items:center;
      gap:2rem; margin-bottom:1rem;
    }
    .panel {
      background:#1c1c1c; padding:1rem; border-radius:8px;
      box-shadow:0 4px 16px rgba(0,0,0,0.6); width:200px;
    }
    .panel img { width:100%; border-radius:4px; }
    .panel h3 { color:#f39c12; margin-top:0.5rem; }

    /* ‚Äî‚Äî Reset & Double Buttons ‚Äî‚Äî */
    #doubleBtn, #btnReset {
      display:block; margin:1rem auto; padding:0.75rem 2rem;
      background:#f39c12; color:#111; border:none; border-radius:6px;
      font-weight:600; text-transform:uppercase; cursor:pointer;
      box-shadow:0 4px 12px rgba(243,156,18,0.5); transition:opacity .3s;
    }
    #doubleBtn:disabled, #btnReset:disabled { opacity:0.5; cursor:default; }
  </style>
</head>
<body>
  <main>
    <header class="header">
      <ul class="nav-links">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="store.html">Store</a></li>
        <li><a href="battle.html" class="active">Battle</a></li>
        <li><a href="profile.html">Profile</a></li>
      </ul>
      <button id="logout" class="btn-pass">Logout</button>
    </header>

    <div id="battleBanner">
      <h1>Battle Zone</h1>
      <p>Welcome to the battle field</p>
    </div>

    <!-- Live Bets Feed (full width) -->
    <div id="fakeBets">
      <h3>Live Bets</h3>
      <!-- JS will inject <p> lines here -->
    </div>

    <div id="statusBar">
      <div id="balance">Balance: $0</div>
      <button id="btnPass" class="btn-pass">
        <img src="assets/battlepass.png" alt="Battle Pass"/>
        Buy Battle Pass ‚Äì $1,000
      </button>
    </div>

    <div id="charGrid"></div>

    <h2 style="color:#f39c12; margin:2rem 0 1rem; text-align:center;">Battle Items</h2>
    <div id="itemGrid"></div>

    <div id="fightControls">
      <input id="betAmount" type="number" min="1" value="1" placeholder="Bet $"/>
      <label><input type="checkbox" id="bringPet"/> Bring Pet ($200)</label>
      <button id="btnBegin" disabled>Begin Fight</button>
      <button id="tournyBtn">üèüÔ∏è Tournament ‚Äì $500</button>
    </div>

    <div id="loader" style="display:none;">
      <h2>Searching For Players üéÆ</h2>
      <div style="animation:spin 1s linear infinite; margin-top:1rem;">üîÑ</div>
    </div>

    <div id="battleLog" style="display:none;"></div>

    <div id="resultPanel" style="display:none;">
      <div class="vs-panel">
        <div class="panel"><h3>You</h3><img id="youImg" src="" alt="Your character"/></div>
        <div class="panel"><h3>Opponent</h3><img id="oppImg" src="" alt="CPU character"/></div>
      </div>
      <h2 id="outcome" style="margin-bottom:1rem;"></h2>
      <button id="doubleBtn" style="display:none;">Double or Nothing</button>
      <button id="btnReset">Reset Match</button>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // ‚Äî Firebase init ‚Äî
    const firebaseConfig = { /* your config */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // DOM refs
    const fakeBetsBox = document.getElementById('fakeBets');
    const betInput    = document.getElementById('betAmount');
    const petCheckbox = document.getElementById('bringPet');
    const tournyBtn   = document.getElementById('tournyBtn');
    const balanceEl   = document.getElementById('balance');
    const btnPass     = document.getElementById('btnPass');
    const charGrid    = document.getElementById('charGrid');
    const itemGrid    = document.getElementById('itemGrid');
    const btnBegin    = document.getElementById('btnBegin');
    const loader      = document.getElementById('loader');
    const battleLog   = document.getElementById('battleLog');
    const resultPanel = document.getElementById('resultPanel');
    const youImg      = document.getElementById('youImg');
    const oppImg      = document.getElementById('oppImg');
    const outcomeEl   = document.getElementById('outcome');
    const doubleBtn   = document.getElementById('doubleBtn');
    const btnReset    = document.getElementById('btnReset');
    const logoutBtn   = document.getElementById('logout');

    // State
    let lastStake=0, doubleClicks=0, tournamentCount=0;
    let userRef, userData, selectedChar=null;
    const chars=Array.from({length:12},(_,i)=>`assets/char${i+1}.jpeg`);
    const items=[
      {name:'Shield',stat:'Protection +50',price:15,asset:'assets/shield.jpeg'},
      {name:'Sword', stat:'Attack +15',    price:15,asset:'assets/swords.jpeg'},
      {name:'Potion',stat:'Block +100',    price:20,asset:'assets/potion.jpeg'},
      {name:'Speed', stat:'Atk Speed +200',price:15,asset:'assets/shoe.jpeg'}
    ];

    // Fake bets feed
    function randomBetLine(){
      let amt = Math.random()<0.8
        ? Math.floor(Math.random()*500+1)
        : (Math.random()*499+1).toFixed(2);
      const stars='*****'.slice(0,Math.floor(Math.random()*5)+1);
      const p=document.createElement('p');
      p.innerText=`${stars} bet $${amt}`;
      fakeBetsBox.appendChild(p);
      if(fakeBetsBox.children.length>50)
        fakeBetsBox.removeChild(fakeBetsBox.firstChild);
    }
    setInterval(randomBetLine,1500);

    auth.onAuthStateChanged(user=>{
      if(!user) return location.replace('index.html');
      logoutBtn.onclick=()=>auth.signOut();
      userRef=db.collection('users').doc(user.uid);
      userRef.onSnapshot(doc=>{
        userData=doc.data()||{};
        updateStatus();
        renderItems();
      });
      renderChars();

      // Begin Fight
      btnBegin.onclick=async()=>{
        const bet=Math.max(1,Number(betInput.value)||1);
        let winChance=0.45;
        if(petCheckbox.checked&&(userData.balance||0)>=200){
          await userRef.update({balance:firebase.firestore.FieldValue.increment(-200)});
          winChance+=0.57;
        }
        if((userData.itemsOwned?.Sword||0)>=1&&(userData.itemsOwned?.Shield||0)>=1){
          winChance+=0.15;
        }
        winChance=Math.min(winChance,0.95);
        runBattle(winChance,bet);
      };

      // Tournament
      tournyBtn.onclick=async()=>{
        if((userData.balance||0)<500) return alert('Need $500 to enter.');
        await userRef.update({balance:firebase.firestore.FieldValue.increment(-500)});
        tournamentCount++;
        const forceWin=(tournamentCount%3)===0;

        loader.querySelector('h2').innerText='Searching For Players üéÆ';
        loader.style.display='block';
        battleLog.style.display='none';
        resultPanel.style.display='none';
        await new Promise(r=>setTimeout(r,10000+Math.random()*10000));
        loader.style.display='none';

        battleLog.innerHTML='';
        battleLog.style.display='block';
        let allWin=true;
        for(let i=1;i<=20;i++){
          const p1=(i%2===1)? selectedChar : chars[Math.floor(Math.random()*chars.length)];
          const p2=chars[Math.floor(Math.random()*chars.length)];
          battleLog.innerHTML+=`
            <div class="vs-panel">
              <div class="panel"><h3>R${i}A</h3><img src="${p1}" alt=""/></div>
              <div class="panel"><h3>R${i}B</h3><img src="${p2}" alt=""/></div>
            </div>`;
          await new Promise(r=>setTimeout(r,1200));
          const win=forceWin||Math.random()<0.5;
          const line=document.createElement('p');
          line.style.color=win?'#9b39b6':'#e74c3c';
          line.innerText=`Round ${i}: ${win?'Win':'Loss'}`;
          battleLog.appendChild(line);
          if(!win){ alert(`üèÅ Eliminated in round ${i}`); allWin=false; break; }
        }
        if(allWin){
          await userRef.update({balance:firebase.firestore.FieldValue.increment(10000)});
          alert('üèÜ You won the tournament! $10,000 prize');
        }
        tournyBtn.disabled=false;
      };
    });

    function updateStatus(){
      balanceEl.textContent=`Balance: $${(userData.balance||0).toLocaleString()}`;
      if(userData.battlePass){
        btnPass.innerHTML='<img src="assets/battlepass.png"/>Battle Pass Owned';
        btnPass.disabled=true;
      } else {
        btnPass.innerHTML='<img src="assets/battlepass.png"/>Buy Battle Pass ‚Äì $1,000';
        btnPass.disabled=(userData.balance||0)<1000;
      }
      document.getElementById('charGrid').style.display=userData.battlePass?'grid':'none';
      document.getElementById('itemGrid').style.display=userData.battlePass?'grid':'none';
      btnBegin.style.display=userData.battlePass?'inline-block':'none';
      btnBegin.disabled=!selectedChar;
    }

    btnPass.onclick=async()=>{
      if((userData.balance||0)<1000) return alert('Not enough balance.');
      await userRef.update({battlePass:true,balance:firebase.firestore.FieldValue.increment(-1000)});
    };

    function renderChars(){
      charGrid.innerHTML='';
      chars.forEach((src,i)=>{
        const card=document.createElement('div');
        card.className='char-card';
        card.innerHTML=`<img src="${src}"/><div class="label">Char ${i+1}</div>`;
        card.onclick=()=>{
          document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          selectedChar=src; updateStatus();
        };
        charGrid.appendChild(card);
      });
    }

    function renderItems(){
      itemGrid.innerHTML='';
      items.forEach(it=>{
        const owned=(userData.itemsOwned?.[it.name]||0);
        const card=document.createElement('div');
        card.className='item-card';
        card.innerHTML=`
          <div class="owned">Owned: ${owned}</div>
          <img src="${it.asset}" alt="${it.name}"/>
          <div class="body">
            <h3>${it.name}</h3>
            <div class="stat">${it.stat}</div>
            <div class="price">Price: $${it.price}</div>
            <input class="quantity" type="number" min="1" value="1"/>
            <button>Buy</button>
          </div>`;
        const btn=card.querySelector('button'), qty=card.querySelector('.quantity');
        btn.onclick=async()=>{
          const q=Math.max(1,Number(qty.value)||1), cost=it.price*q;
          if((userData.balance||0)<cost) return alert('‚ùå Not enough balance.');
          await userRef.update({
            balance:firebase.firestore.FieldValue.increment(-cost),
            [`itemsOwned.${it.name}`]:firebase.firestore.FieldValue.increment(q)
          });
          alert(`‚úÖ Purchased ${q}√ó ${it.name}!`);
        };
        itemGrid.appendChild(card);
      });
    }

    function runBattle(winChance,bet){
      loader.style.display='block';
      btnBegin.style.display='none';
      battleLog.style.display='none';
      resultPanel.style.display='none';
      doubleBtn.style.display='none';
      setTimeout(()=>{
        loader.style.display='none';
        battleLog.style.display='block';
        showResult(winChance,bet);
      },1000);
    }

    async function showResult(winChance,bet){
      const cpu=chars[Math.floor(Math.random()*chars.length)];
      youImg.src=selectedChar; oppImg.src=cpu;
      resultPanel.style.display='block';
      const win=Math.random()<winChance;
      const delta=win?bet:-bet;
      outcomeEl.textContent=win?`üéâ Victory! You won $${bet}`:`üò¢ Defeat‚Ä¶ You lost $${bet}`;
      await userRef.update({balance:firebase.firestore.FieldValue.increment(delta)});
      if(win){
        lastStake=bet; doubleClicks=0;
        doubleBtn.disabled=false; doubleBtn.style.display='block';
      } else {
        doubleBtn.style.display='none';
      }
    }

    doubleBtn.onclick=async()=>{
      doubleClicks++;
      const stake=lastStake*2;
      if(doubleClicks>=3){
        await userRef.update({balance:firebase.firestore.FieldValue.increment(-lastStake)});
        alert(`üí• You lost $${lastStake}!`);
        doubleBtn.disabled=true; return;
      }
      const win=Math.random()<0.5;
      if(win){
        await userRef.update({balance:firebase.firestore.FieldValue.increment(stake)});
        lastStake=stake; alert(`üéâ You doubled to $${stake}!`);
      } else {
        await userRef.update({balance:firebase.firestore.FieldValue.increment(-stake)});
        alert(`üò¢ You lost $${stake}!`);
        doubleBtn.disabled=true;
      }
    };

    btnReset.onclick=()=>{
      resultPanel.style.display='none';
      doubleBtn.style.display='none';
      btnBegin.style.display='inline-block';
      battleLog.style.display='none';
      selectedChar=null;
      document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
      updateStatus();
    };

    document.head.insertAdjacentHTML('beforeend',`
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    `);
  </script>
</body>
</html>
