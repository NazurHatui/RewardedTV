<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>RewardedTV â€“ Battle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <style>
    /* â€”â€” Global & Reset â€”â€” */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',sans-serif; background:#0a0a0a; color:#e0e0e0; }

    /* â€”â€” Header (reuse your siteâ€™s header style) â€”â€” */
    header.header {
      display:flex; justify-content:space-between; align-items:center;
      padding:1rem 2rem; background:#111; position:sticky; top:0; z-index:10;
    }
    .nav-links { list-style:none; display:flex; gap:1rem; }
    .nav-links a { color:#e0e0e0; text-decoration:none; font-weight:500; }
    .nav-links a.active { color:#f39c12; }

    /* â€”â€” Main container â€”â€” */
    main { padding:2rem; max-width:1200px; margin:0 auto; }

    /* â€”â€” Battle Zone Banner â€”â€” */
    #battleBanner {
      background:rgba(243,156,18,0.1);
      border:2px solid #f39c12;
      border-radius:8px;
      padding:1rem;
      text-align:center;
      margin-bottom:1rem;
    }
    #battleBanner h1 {
      font-size:2.5rem;
      color:#f39c12;
      margin-bottom:0.5rem;
    }
    #battleBanner p {
      color:#ccc;
      font-size:1rem;
    }

    /* â€”â€” Status Bar â€”â€” */
    #statusBar {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:2rem;
    }
    #balance { font-size:1.25rem; }
    .btn-pass {
      display:flex; align-items:center;
      padding:0.75rem 1.5rem; background:linear-gradient(45deg,#9b59b6,#e74c3c);
      color:#111; border:none; border-radius:6px; cursor:pointer;
      text-transform:uppercase; font-weight:600;
      box-shadow:0 4px 12px rgba(231,76,60,0.5);
      transition:opacity .3s;
    }
    .btn-pass img {
      height:1em; margin-right:0.5em;
    }
    .btn-pass:disabled { opacity:0.5; cursor:default; }

    /* â€”â€” Character Grid â€”â€” */
    #charGrid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:1.5rem; margin-bottom:2rem;
    }
    .char-card {
      background:#1c1c1c; border-radius:8px;
      padding:1rem; text-align:center;
      box-shadow:0 4px 16px rgba(0,0,0,0.6);
      transition:transform .3s,box-shadow .3s;
      cursor:pointer; position:relative; perspective:1000px;
    }
    .char-card.selected {
      box-shadow:0 0 0 4px #f39c12;
      transform:scale(1.05);
    }
    .char-card img {
      width:100%; border-radius:4px; margin-bottom:0.5rem;
      transform: translateZ(20px);
    }
    .char-card .label {
      color:#ccc; margin-bottom:.5rem;
    }

    /* â€”â€” Battle Items Grid â€”â€” */
    #itemGrid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1.5rem; margin:2rem 0;
    }
    .item-card {
      background:#1c1c1c; border-radius:8px; overflow:hidden;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
      display:flex; flex-direction:column;
      transition:transform .3s,box-shadow .3s;
      position:relative;
    }
    .item-card:hover {
      transform:translateY(-6px);
      box-shadow:0 12px 30px rgba(0,0,0,0.8);
    }
    .item-card img {
      width:100%; height:120px; object-fit:contain;
      background:#000; padding:1rem;
    }
    .item-card .owned {
      position:absolute; top:8px; right:8px;
      background:rgba(0,0,0,0.6); color:#f39c12;
      padding:2px 6px; border-radius:4px; font-size:0.75rem;
    }
    .item-card .body {
      padding:1rem; flex:1; display:flex; flex-direction:column; align-items:center;
    }
    .item-card .body h3 {
      color:#f39c12; margin-bottom:0.5rem; font-size:1.1rem;
    }
    .item-card .body .stat,
    .item-card .body .price {
      color:#ccc; font-size:0.9rem; margin-bottom:0.5rem;
    }
    .item-card .body .quantity {
      width:60px; text-align:center; margin-bottom:1rem;
      padding:0.25rem; border-radius:4px; border:none;
    }
    .item-card .body button {
      margin-top:auto; width:100%; padding:0.6rem;
      background:linear-gradient(45deg,#9b59b6,#e74c3c);
      color:#111; border:none; border-radius:6px;
      font-weight:600; cursor:pointer; text-transform:uppercase;
      box-shadow:0 0 10px rgba(231,76,60,0.7); transition:background .3s;
    }
    .item-card .body button:hover {
      background:linear-gradient(45deg,#e74c3c,#9b59b6);
    }

    /* â€”â€” Begin Fight Button â€”â€” */
    #btnBegin {
      display:block; margin:0 auto 2rem;
      padding:0.75rem 2rem; font-size:1rem;
      background:linear-gradient(45deg,#e74c3c,#9b59b6);
      color:#111; border:none; border-radius:6px; cursor:pointer;
      text-transform:uppercase; font-weight:600;
      box-shadow:0 4px 12px rgba(231,76,60,0.5);
      transition:opacity .3s;
    }
    #btnBegin:disabled { opacity:0.5; cursor:default; }

    /* â€”â€” VS Loader, Battle Log & Panels â€”â€” */
    #loader, #battleLog, #resultPanel { text-align:center; margin-top:3rem; }
    #battleLog {
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      color: #ccc;
      font-family: monospace;
      margin-top: 1rem;
    }
    .vs-panel {
      display:flex; justify-content:space-around; align-items:center;
      gap:2rem; margin-top:2rem;
    }
    .panel { background:#1c1c1c; padding:1rem; border-radius:8px;
      box-shadow:0 4px 16px rgba(0,0,0,0.6); width:200px; }
    .panel img { width:100%; border-radius:4px; }
    .panel h3 { margin-top:.5rem; font-size:1.1rem; color:#f39c12; }

    /* â€”â€” Reset â€”â€” */
    #btnReset {
      margin-top:2rem; padding:.5rem 1.5rem; background:#444;
      border:none; border-radius:4px; color:#e0e0e0; cursor:pointer;
    }
  </style>
</head>
<body>
  <header class="header">
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="store.html">Store</a></li>
      <li><a href="battle.html" class="active">Battle</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
    <button id="logout" class="btn-pass">Logout</button>
  </header>

  <main>
    <!-- Battle Zone Banner -->
    <div id="battleBanner">
      <h1>Battle Zone</h1>
      <p>Welcome to the battle field</p>
    </div>

    <!-- Status Bar -->
    <div id="statusBar">
      <div id="balance">Balance: $0</div>
      <button id="btnPass" class="btn-pass">
        <img src="assets/battlepass.png" alt="Battle Pass"/>Buy Battle Pass â€“ $3,000
      </button>
    </div>

    <!-- Character Selection -->
    <div id="charGrid"></div>

    <!-- Battle Items Section -->
    <h2 style="color:#f39c12; margin-top:2rem; text-align:center;">Battle Items</h2>
    <div id="itemGrid"></div>

    <!-- Begin Fight -->
    <button id="btnBegin" disabled>Begin Fight</button>

    <!-- VS Loader -->
    <div id="loader" style="display:none;">
      <h2>Finding Opponentâ€¦</h2>
      <div style="margin-top:1rem; animation:spin 1s linear infinite;">ðŸ”„</div>
    </div>

    <!-- Battle Log -->
    <div id="battleLog" style="display:none;"></div>

    <!-- Battle Panels & Result -->
    <div id="resultPanel" style="display:none;">
      <div class="vs-panel">
        <div class="panel">
          <h3>You</h3>
          <img id="youImg" src="" alt="Your character"/>
        </div>
        <div class="panel">
          <h3>Opponent</h3>
          <img id="oppImg" src="" alt="CPU character"/>
        </div>
      </div>
      <h2 id="outcome" style="margin-top:2rem;"></h2>
      <button id="btnReset">Reset Match</button>
    </div>
  </main>

  <!-- Firebase & Logic (with turn-by-turn battle log) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // â€” Firebase init â€”
    const firebaseConfig = {
      apiKey: "AIzaSyAZJwv-o931FA_nRB68UiT7gHIuzx-e5rQ",
      authDomain: "rewardedtv-1e5b1.firebaseapp.com",
      projectId: "rewardedtv-1e5b1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // â€” DOM refs â€”
    const balanceEl   = document.getElementById('balance');
    const btnPass     = document.getElementById('btnPass');
    const charGrid    = document.getElementById('charGrid');
    const itemGrid    = document.getElementById('itemGrid');
    const btnBegin    = document.getElementById('btnBegin');
    const loader      = document.getElementById('loader');
    const battleLog   = document.getElementById('battleLog');
    const resultPanel = document.getElementById('resultPanel');
    const youImg      = document.getElementById('youImg');
    const oppImg      = document.getElementById('oppImg');
    const outcomeEl   = document.getElementById('outcome');
    const btnReset    = document.getElementById('btnReset');
    const logoutBtn   = document.getElementById('logout');

    // â€” State â€”
    let userRef, userData, selectedChar = null;
    const chars = Array.from({length:12},(_,i)=>`assets/char${i+1}.jpeg`);
    const items = [
      { name:'Shield', stat:'Protection +50', price:15, asset:'assets/shield.jpeg'  },
      { name:'Sword',  stat:'Attack +15',     price:15, asset:'assets/swords.jpeg'  },
      { name:'Potion', stat:'Block +100',     price:20, asset:'assets/potion.jpeg'  },
      { name:'Speed',  stat:'Atk Speed +200', price:15, asset:'assets/shoe.jpeg'    },
    ];

    auth.onAuthStateChanged(user => {
      if (!user) return location.replace('index.html');
      logoutBtn.onclick = () => auth.signOut();
      userRef = db.collection('users').doc(user.uid);
      userRef.onSnapshot(doc => {
        userData = doc.data()||{};
        updateStatus();
        renderItems();
      });
      renderChars();
    });

    function updateStatus(){
      balanceEl.textContent = `Balance: $${(userData.balance||0).toLocaleString()}`;
      // battle pass
      if (userData.battlePass) {
        btnPass.innerHTML = '<img src="assets/battlepass.png" alt="Battle Pass"/>Battle Pass Owned';
        btnPass.disabled  = true;
      } else {
        btnPass.innerHTML = '<img src="assets/battlepass.png" alt="Battle Pass"/>Buy Battle Pass â€“ $3,000';
        btnPass.disabled  = (userData.balance||0) < 3000;
      }
      charGrid.style.display   = userData.battlePass ? 'grid' : 'none';
      itemGrid.style.display   = userData.battlePass ? 'grid' : 'none';
      btnBegin.style.display   = userData.battlePass ? 'block' : 'none';
      btnBegin.disabled        = !selectedChar;
    }

    btnPass.onclick = async () => {
      if ((userData.balance||0) < 3000) return alert('Not enough balance.');
      await userRef.update({
        battlePass: true,
        balance: firebase.firestore.FieldValue.increment(-3000)
      });
    };

    function renderChars(){
      charGrid.innerHTML = '';
      chars.forEach((src,i) => {
        const card = document.createElement('div');
        card.className = 'char-card';
        card.innerHTML = `
          <img src="${src}" alt="Char ${i+1}">
          <div class="label">Char ${i+1}</div>
        `;
        card.onclick = () => {
          document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          selectedChar = src;
          updateStatus();
        };
        charGrid.append(card);
      });
    }

    function renderItems(){
      itemGrid.innerHTML = '';
      items.forEach(it => {
        const ownedCount = (userData.itemsOwned && userData.itemsOwned[it.name]) || 0;
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
          <div class="owned">Owned: ${ownedCount}</div>
          <img src="${it.asset}" alt="${it.name}">
          <div class="body">
            <h3>${it.name}</h3>
            <div class="stat">${it.stat}</div>
            <div class="price">Price: $${it.price}</div>
            <input class="quantity" type="number" min="1" value="1"/>
            <button>Buy</button>
          </div>
        `;
        const btn  = card.querySelector('button');
        const qtyI = card.querySelector('.quantity');
        btn.onclick = async () => {
          const qty = Math.max(1, Number(qtyI.value)||1);
          const cost = it.price * qty;
          if ((userData.balance||0) < cost) return alert('âŒ Not enough balance.');
          await userRef.update({
            balance: firebase.firestore.FieldValue.increment(-cost),
            [`itemsOwned.${it.name}`]: firebase.firestore.FieldValue.increment(qty)
          });
          alert(`âœ… Purchased ${qty}Ã— ${it.name}!`);
        };
        itemGrid.append(card);
      });
    }

    btnBegin.onclick = () => {
      loader.style.display   = 'block';
      btnBegin.style.display = 'none';
      battleLog.style.display = 'none';
      resultPanel.style.display = 'none';
      setTimeout(runBattle, 1000);
    };

    function runBattle(){
      loader.style.display = 'none';
      // build log
      const log = ['Battle begunâ€¦'];
      let attacker = 'You', defender = 'Opponent';
      for (let i=0; i<6; i++){
        log.push(`${attacker} attacks ${defender}`);
        if (Math.random()<0.5){
          log.push(`${defender} blocks`);
        } else {
          const dmg = Math.floor(Math.random()*200)+50;
          log.push(`${defender} takes ${dmg}`);
        }
        [attacker, defender] = [defender, attacker];
      }
      // show log
      battleLog.textContent = '';
      battleLog.style.display = 'block';
      let idx = 0;
      const interval = setInterval(()=>{
        if (idx < log.length){
          battleLog.textContent += log[idx++] + '\n';
        } else {
          clearInterval(interval);
          showResult();
        }
      }, 700);
    }

    function showResult(){
      // pick images & payout
      const cpuSrc = chars[Math.floor(Math.random()*chars.length)];
      youImg.src = selectedChar;
      oppImg.src = cpuSrc;
      resultPanel.style.display = 'block';

      const payout = Math.floor(Math.random()*996)+5;
      const win    = Math.random()<0.45;
      const delta  = win ? payout : -payout;
      outcomeEl.textContent = win
        ? `ðŸŽ‰ Victory! You earned $${payout}`
        : `ðŸ˜¢ Defeatâ€¦ You lost $${payout}`;

      // update balance & decrement one of each owned item
      const updates = { balance: firebase.firestore.FieldValue.increment(delta) };
      if (userData.itemsOwned){
        Object.keys(userData.itemsOwned).forEach(name => {
          if ((userData.itemsOwned[name]||0) > 0){
            updates[`itemsOwned.${name}`] = firebase.firestore.FieldValue.increment(-1);
          }
        });
      }
      userRef.update(updates);
    }

    btnReset.onclick = () => {
      resultPanel.style.display = 'none';
      battleLog.style.display   = 'none';
      selectedChar = null;
      document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
      btnBegin.style.display = 'block';
      updateStatus();
    };

    // spinner animation
    document.head.insertAdjacentHTML('beforeend',`
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    `);
  </script>
</body>
</html>
