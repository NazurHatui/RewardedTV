<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Helpers & Pets Marketplace â€” RewardedTV</title>
  <style>
    /* Base & Theme */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',sans-serif;background:#0a0a0a;color:#e0e0e0;}
    a{color:inherit;text-decoration:none;}

    /* Header */
    .market-header{
      display:flex;justify-content:space-between;align-items:center;
      padding:1rem 2rem;background:#111;position:sticky;top:0;z-index:10;
    }
    .market-header h1{color:#9b59b6;font-size:1.75rem;text-shadow:0 0 8px rgba(155,89,182,0.7);}
    .market-header .controls{display:flex;gap:1rem;}
    .market-header select,input{background:#1c1c1c;border:1px solid #9b59b6;color:#e0e0e0;padding:0.5rem;border-radius:4px;}

    /* Section Titles */
    section h2{margin:1.5rem 2rem 0.5rem;color:#f39c12;}

    /* Grid Layout */
    .market-grid{padding:0 2rem 2rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.5rem;}

    /* Card */
    .card{
      background:#1c1c1c;border-radius:8px;overflow:hidden;position:relative;
      box-shadow:0 4px 16px rgba(0,0,0,0.5);transition:transform .2s;
    }
    .card:hover{transform:translateY(-5px);}
    .card img{width:100%;display:block;}
    .card-body{padding:1rem;display:flex;flex-direction:column;align-items:center;}
    .card-body h2{font-size:1.1rem;color:#f39c12;margin-bottom:0.5rem;}
    .card-body p{margin-bottom:0.75rem;font-size:0.9rem;color:#ccc;}
    .btn-buy{
      background:#9b59b6;color:#111;padding:0.5rem 1rem;border:none;border-radius:4px;
      cursor:pointer;width:100%;font-weight:500;text-transform:uppercase;
      box-shadow:0 0 8px rgba(155,89,182,0.6);
    }
    .btn-buy:hover{background:#8e44ad;}

    /* Neon Glow Overlay */
    .card::before{
      content:'';position:absolute;top:0;left:0;width:100%;height:100%;
      box-shadow:0 0 12px rgba(155,89,182,0.8) inset;opacity:0;transition:opacity .2s;
    }
    .card:hover::before{opacity:1;}
  </style>
</head>
<body>
  <header class="market-header">
    <h1>Helpers & Pets Marketplace</h1>
    <div class="controls">
      <select id="filterType">
        <option value="">All Types</option>
        <option value="Helper">Helper</option>
        <option value="Pet">Pet</option>
      </select>
      <select id="filterRarity">
        <option value="">All Rarities</option>
        <option value="Common">Common</option>
        <option value="Rare">Rare</option>
        <option value="Epic">Epic</option>
      </select>
      <input type="text" id="searchInput" placeholder="Search..." />
    </div>
  </header>

  <!-- Your Collection -->
  <section id="collectionSection" style="display:none;">
    <h2>Your Collection</h2>
    <div id="collectionGrid" class="market-grid"></div>
  </section>

  <!-- Global Marketplace -->
  <section>
    <h2>All Listings</h2>
    <div id="globalGrid" class="market-grid"></div>
  </section>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // â€”â€”â€” Init Firebase â€”â€”â€”
    const firebaseConfig = {
      apiKey: "AIzaSyAZJwv-o931FA_nRB68UiT7gHIuzx-e5rQ",
      authDomain: "rewardedtv-1e5b1.firebaseapp.com",
      projectId: "rewardedtv-1e5b1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // â€”â€”â€” Helper to build each card, falling back to assets/charN.jpeg â€”â€”â€”
    function makeCard(item, isOwn=false) {
      // derive a safe image path if avatarURL missing
      let imgSrc = item.avatarURL;
      if (!imgSrc && item.name.match(/^char\d+$/i)) {
        imgSrc = `assets/${item.name.toLowerCase()}.jpeg`;
      }
      return `
        <div class="card">
          <img src="${imgSrc}" alt="${item.name}" />
          <div class="card-body">
            <h2>${item.name}</h2>
            <p>Price: ${item.price || 'TBD'}â‚µ</p>
            <button class="btn-buy" data-id="${item.id}" data-own="${isOwn}">
              ${isOwn ? 'List for Sale' : 'Buy Now'}
            </button>
          </div>
        </div>`;
    }

    // â€”â€”â€” Load Global Listings â€”â€”â€”
    function loadGlobal() {
      db.collection('marketplace')
        .get()
        .then(snap => {
          const out = [];
          snap.forEach(doc => {
            const d = doc.data(); d.id = doc.id;
            out.push(d);
          });
          document.getElementById('globalGrid').innerHTML = out.map(i=>makeCard(i,false)).join('');
        });
    }

    // â€”â€”â€” On Auth, load your collection + global â€”â€”â€”
    auth.onAuthStateChanged(user=>{
      if(!user) return location.replace('index.html');
      db.collection('users').doc(user.uid).get().then(doc=>{
        const d = doc.data()||{};
        const owned = (d.helpers||[]).concat(d.pets||[]);
        if(owned.length){
          document.getElementById('collectionSection').style.display = 'block';
          document.getElementById('collectionGrid').innerHTML =
            owned.map(item=>{
              item.id = item.name; // unique key
              return makeCard(item,true);
            }).join('');
        }
      });
      loadGlobal();
    });

    // â€”â€”â€” List / Buy Handlers â€”â€”â€”
    document.body.addEventListener('click', e=>{
      if(!e.target.classList.contains('btn-buy')) return;
      const id    = e.target.dataset.id;
      const isOwn = e.target.dataset.own === 'true';

      if(isOwn){
        const price = prompt('Set your price in credits:');
        if (!price) return;
        const uid = auth.currentUser.uid;
        // remove from user
        db.collection('users').doc(uid).update({
          helpers: firebase.firestore.FieldValue.arrayRemove({ name: id }),
          pets:    firebase.firestore.FieldValue.arrayRemove({ name: id })
        }).then(()=>{
          // add to marketplace
          db.collection('marketplace').add({ name:id, avatarURL:`assets/${id}.jpeg`, price })
            .then(()=>alert('âœ… Listed!'))
            .catch(console.error);
        });
      } else {
        alert('ðŸš§ Buy flow not yet implemented');
      }
    });
  </script>
</body>
</html>
